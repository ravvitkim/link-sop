# ğŸ¤– RAG Chatbot v9.0

**LangGraph ìƒíƒœ ë¨¸ì‹  ê¸°ë°˜ GMP/SOP ë¬¸ì„œ ì²˜ë¦¬ ì‹œìŠ¤í…œ**

PDF, DOCX, HTML ë¬¸ì„œë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜í•˜ê³ , ê³„ì¸µì  ì„¹ì…˜ êµ¬ì¡°ë¥¼ ì¶”ì¶œí•˜ì—¬ ë²¡í„° DBì— ì €ì¥í•˜ëŠ” RAG(Retrieval-Augmented Generation) ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ğŸ†• v9.0 ì£¼ìš” ë³€ê²½ì‚¬í•­

### ğŸ”¥ LangGraph ìƒíƒœ ë¨¸ì‹  ë„ì…

ê¸°ì¡´ ì„ í˜• íŒŒì´í”„ë¼ì¸ì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ **LangGraph**ë¥¼ ë„ì…í–ˆìŠµë‹ˆë‹¤:

| ê¸°ì¡´ (v8.0 ì„ í˜•) | ì‹ ê·œ (v9.0 LangGraph) |
|-----------------|----------------------|
| ìˆœì°¨ ì‹¤í–‰ë§Œ ê°€ëŠ¥ | ì¡°ê±´ë¶€ ë¶„ê¸° ì²˜ë¦¬ |
| ì‹¤íŒ¨ ì‹œ ì „ì²´ ì¤‘ë‹¨ | í´ë°± ì „ëµ ìë™ ì‹¤í–‰ |
| ê³ ì •ëœ ì²˜ë¦¬ íë¦„ | í’ˆì§ˆ ê¸°ë°˜ ë™ì  ë¼ìš°íŒ… |
| ì—ëŸ¬ ì¶”ì  ì–´ë ¤ì›€ | ìƒíƒœ ê¸°ë°˜ ì—ëŸ¬ ëˆ„ì  |

### ğŸ“¦ LangGraph í•µì‹¬ ê°œë…

```python
from langgraph.graph import StateGraph, END

# 1. ìƒíƒœ ì •ì˜ (TypedDict)
class PipelineState(TypedDict):
    filename: str
    content: bytes
    markdown: str
    quality_score: float
    errors: Annotated[List[str], operator.add]  # ì—ëŸ¬ ëˆ„ì 
    ...

# 2. ë…¸ë“œ í•¨ìˆ˜
def node_convert(state): ...
def node_validate(state): ...

# 3. ì¡°ê±´ë¶€ ë¼ìš°íŒ…
def should_fallback(state) -> Literal["fallback", "validate"]:
    if state.get("errors"):
        return "fallback"
    return "validate"

# 4. ê·¸ë˜í”„ ë¹Œë“œ
workflow = StateGraph(PipelineState)
workflow.add_node("convert", node_convert)
workflow.add_conditional_edges("convert", should_fallback, {...})
pipeline = workflow.compile()
```

---

## ğŸ”„ LangGraph íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load   â”‚â”€â”€â”€â–¶â”‚ Convert â”‚â”€â”€â”€â–¶â”‚ Validate â”‚â”€â”€â”€â–¶â”‚  Split  â”‚â”€â”€â”€â–¶â”‚ Optimize â”‚â”€â”€â”€â–¶â”‚ Finalize â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚              â”‚
                    â–¼              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Fallback â”‚  â”‚  Repair  â”‚
              â”‚ (ë³€í™˜ì‹¤íŒ¨)â”‚  â”‚ (í’ˆì§ˆâ†“) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë…¸ë“œë³„ ìƒì„¸ ê¸°ëŠ¥

| ë…¸ë“œ | ê¸°ëŠ¥ | ë¶„ê¸° ì¡°ê±´ |
|------|------|----------|
| **Load** | íŒŒì¼ íƒ€ì… ê°ì§€ (ì‹¤ì œ í™•ì¥ì ê¸°ì¤€) | - |
| **Convert** | ë¬¸ì„œ â†’ ë§ˆí¬ë‹¤ìš´ ë³€í™˜ | ì‹¤íŒ¨ ì‹œ â†’ Fallback |
| **Fallback** | ëŒ€ì²´ íŒŒì„œ ì‹œë„ | PDF: pdfplumber â†’ Docling â†’ PyMuPDF â†’ PyPDF2 |
| **Validate** | í’ˆì§ˆ ì ìˆ˜ ê³„ì‚° (0~100%) | ì ìˆ˜ < 50% â†’ Repair |
| **Repair** | í—¤ë” ì¶”ë¡ , í…Œì´ë¸” ë³µêµ¬, íŠ¹ìˆ˜ë¬¸ì ì œê±° | - |
| **Split** | ë§ˆí¬ë‹¤ìš´ í—¤ë” ê¸°ì¤€ ë¶„í•  | - |
| **Optimize** | ê¸´ ì„¹ì…˜ ì¬ë¶„í•  + ì»¨í…ìŠ¤íŠ¸ í”„ë¦¬í”½ìŠ¤ | - |
| **Finalize** | ê²°ê³¼ ì •ë¦¬ ë° í†µê³„ | - |

### ì¡°ê±´ë¶€ ë¼ìš°íŒ… ë¡œì§

```python
# 1. ë³€í™˜ ì‹¤íŒ¨ â†’ í´ë°±
def should_fallback(state) -> Literal["fallback", "validate"]:
    if state.get("errors") or not state.get("markdown"):
        return "fallback"
    return "validate"

# 2. í’ˆì§ˆ ë‚®ìŒ â†’ ë³´ì •
def should_repair(state) -> Literal["repair", "split"]:
    if state.get("quality_score", 0) < 0.5 and state.get("retry_count", 0) < 2:
        return "repair"
    return "split"
```

---

## ğŸ“Š í’ˆì§ˆ ê²€ì¦ ì‹œìŠ¤í…œ

5ê°€ì§€ í•­ëª©ìœ¼ë¡œ ë¬¸ì„œ ë³€í™˜ í’ˆì§ˆì„ 0~100%ë¡œ ì¸¡ì •:

| í•­ëª© | ê¸°ì¤€ | ë°°ì  |
|------|------|------|
| í…ìŠ¤íŠ¸ ê¸¸ì´ | â‰¥ 100ì | 20% |
| í—¤ë” ê°œìˆ˜ | â‰¥ 3ê°œ | 30% |
| ë¬¸ë‹¨ êµ¬ì¡° | â‰¥ 5ê°œ | 20% |
| í•œê¸€ ë¹„ìœ¨ | â‰¥ 10% | 20% |
| íŠ¹ìˆ˜ë¬¸ì ì˜¤ì—¼ | < 1% | 10% |

**í’ˆì§ˆ ì ìˆ˜ < 50%** ì´ë©´ ìë™ìœ¼ë¡œ `Repair` ë…¸ë“œë¡œ ë¼ìš°íŒ…ë˜ì–´ ë³´ì • ìˆ˜í–‰.

---

## ğŸ“„ ì§€ì› íŒŒì¼ í˜•ì‹

| í˜•ì‹ | íŒŒì„œ | íŠ¹ì§• |
|------|------|------|
| `.docx` | python-docx | Word ìŠ¤íƒ€ì¼ + íŒ¨í„´ ê¸°ë°˜ í—¤ë” ê°ì§€ |
| `.pdf` | pdfplumber (1ìˆœìœ„) | ë‹¤ì¤‘ í´ë°± + í—¤ë” ì¶”ë¡  |
| `.html` | BeautifulSoup | HTML íƒœê·¸ â†’ ë§ˆí¬ë‹¤ìš´ |
| `.md` | ì§ì ‘ ì²˜ë¦¬ | íŒ¨ìŠ¤ìŠ¤ë£¨ |
| `.txt` | í—¤ë” ì¶”ë¡  | íŒ¨í„´ ê¸°ë°˜ |

### PDF í´ë°± ìˆœì„œ

```
1. pdfplumber (ê°€ì¥ ì•ˆì •ì )
2. Docling (ìµœê³  í’ˆì§ˆ, ë¬´ê±°ì›€)
3. PyMuPDF (fitz)
4. PyPDF2
```

---

## ğŸ” ê³„ì¸µì  ì„¹ì…˜ ê²½ë¡œ (section_path)

ë¬¸ì„œì˜ ê³„ì¸µ êµ¬ì¡°ë¥¼ ì¶”ì í•˜ì—¬ ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ:

```
ğŸ“ 5 ì ˆì°¨ Procedure
ğŸ“ 5 ì ˆì°¨ Procedure > 5.1 í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ êµ¬ì„± ë° ê´€ë¦¬
ğŸ“ 5 ì ˆì°¨ Procedure > 5.1 í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ êµ¬ì„± ë° ê´€ë¦¬ > 5.1.1 ë¬¸ì„œë²ˆí˜¸ ì²´ê³„
```

### ì»¨í…ìŠ¤íŠ¸ í”„ë¦¬í”½ìŠ¤ (v8.1+)

ê¸´ ì„¹ì…˜ì´ ì¬ë¶„í• ë  ë•Œ, ë‘ ë²ˆì§¸ ì²­í¬ë¶€í„° í—¤ë” ê²½ë¡œë¥¼ í…ìŠ¤íŠ¸ì— ì‚½ì…:

```
[Context: 5 ì ˆì°¨ Procedure > 5.1 í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ êµ¬ì„± ë° ê´€ë¦¬]

í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œëŠ” ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•œë‹¤...
```

---

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
rag_chatbot/
â”œâ”€â”€ main.py                      # FastAPI ì„œë²„ (v9.0)
â”œâ”€â”€ requirements.txt             # ì˜ì¡´ì„±
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ rag/                         # RAG ëª¨ë“ˆ
â”‚   â”œâ”€â”€ __init__.py              # íŒ¨í‚¤ì§€ ì´ˆê¸°í™”
â”‚   â”œâ”€â”€ document_pipeline.py     # ğŸ”¥ LangGraph íŒŒì´í”„ë¼ì¸ (í•µì‹¬)
â”‚   â”œâ”€â”€ document_processor.py    # v8.0 ì„ í˜• íŒŒì´í”„ë¼ì¸ (í´ë°±)
â”‚   â”œâ”€â”€ document_loader.py       # ë¬¸ì„œ ë¡œë” (Neo4j ê·¸ë˜í”„ìš©)
â”‚   â”œâ”€â”€ chunker.py               # ì²­í‚¹ ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ prompt.py                # RAG í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
â”‚   â”œâ”€â”€ vector_store.py          # ChromaDB ë²¡í„° ìŠ¤í† ì–´
â”‚   â”œâ”€â”€ graph_store.py           # Neo4j ê·¸ë˜í”„ ìŠ¤í† ì–´
â”‚   â””â”€â”€ llm.py                   # LLM ì—°ë™ (Ollama/HuggingFace)
â”‚
â”œâ”€â”€ frontend/                    # React í”„ë¡ íŠ¸ì—”ë“œ
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”œâ”€â”€ App.css
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ package.json
â”‚
â””â”€â”€ chroma_db/                   # ë²¡í„° DB ì €ì¥ì†Œ (ìë™ ìƒì„±)
```

---

## ğŸš€ ì„¤ì¹˜ ë° ì‹¤í–‰

### 1. ì˜ì¡´ì„± ì„¤ì¹˜

```bash
pip install -r requirements.txt
```

**ì£¼ìš” ì˜ì¡´ì„±:**
- `langgraph` - ìƒíƒœ ë¨¸ì‹  íŒŒì´í”„ë¼ì¸
- `pdfplumber`, `PyMuPDF`, `PyPDF2` - PDF íŒŒì‹±
- `python-docx` - DOCX íŒŒì‹±
- `chromadb` - ë²¡í„° ìŠ¤í† ì–´
- `neo4j` - ê·¸ë˜í”„ DB (ì„ íƒ)

### 2. ì„œë²„ ì‹¤í–‰

```bash
python main.py
```

ì„œë²„ê°€ `http://localhost:8000`ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

### 3. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰ (ì„ íƒ)

```bash
cd frontend
npm install
npm run dev
```

---

## ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸

### ë¬¸ì„œ ì—…ë¡œë“œ

```http
POST /rag/upload
```

| íŒŒë¼ë¯¸í„° | íƒ€ì… | ê¸°ë³¸ê°’ | ì„¤ëª… |
|----------|------|--------|------|
| file | File | í•„ìˆ˜ | ì—…ë¡œë“œí•  ë¬¸ì„œ |
| collection | string | "documents" | ì»¬ë ‰ì…˜ ì´ë¦„ |
| chunk_size | int | 200 | ì²­í¬ í¬ê¸° |
| overlap | int | 50 | ì²­í¬ ì˜¤ë²„ë© |
| model | string | "multilingual-e5-small" | ì„ë² ë”© ëª¨ë¸ |
| use_langgraph | bool | true | ğŸ”¥ LangGraph ì‚¬ìš© ì—¬ë¶€ |

**ì‘ë‹µ:**
```json
{
  "success": true,
  "filename": "EQ-SOP-00010.docx",
  "sop_id": "EQ-SOP-00010",
  "chunks": 34,
  "pipeline_version": "v9.0-langgraph",
  "quality_score": 1.0,
  "conversion_method": "python-docx",
  "warnings": []
}
```

### ê²€ìƒ‰

```http
POST /rag/search
```

```json
{
  "query": "í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ ëª©ì ì€?",
  "collection": "documents",
  "n_results": 5
}
```

### ì±—ë´‡

```http
POST /chat
```

```json
{
  "message": "í’ˆì§ˆê´€ë¦¬ì±…ì„ìì˜ ì—­í• ì€?",
  "collection": "documents",
  "llm_model": "qwen2.5:3b"
}
```

### RAG ë‹µë³€

```http
POST /rag/ask
```

```json
{
  "query": "ë³€ê²½ê´€ë¦¬ ì ˆì°¨ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”",
  "collection": "documents",
  "check_clarification": true
}
```

---

## ğŸ“ ë¬¸ì„œ í˜•ì‹ë³„ ì²˜ë¦¬

### DOCX (ìˆ«ìí˜• í—¤ë”)

| ì›ë³¸ | section_path |
|------|--------------|
| `5 ì ˆì°¨ Procedure` | `5 ì ˆì°¨ Procedure` |
| `5.1 í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ êµ¬ì„±` | `5 ì ˆì°¨ Procedure > 5.1 í’ˆì§ˆê´€ë¦¬ê¸°ì¤€ì„œì˜ êµ¬ì„±` |

### DOCX (ì´ë¦„í˜• í—¤ë”)

| ì›ë³¸ | section_path |
|------|--------------|
| `ì ˆì°¨ Procedure` | `ì ˆì°¨ Procedure` |
| `ë³€ê²½(ê°œì •) ê´€ë¦¬ (Revision)` | `ì ˆì°¨ Procedure > ë³€ê²½(ê°œì •) ê´€ë¦¬ (Revision)` |

### PDF (í—¤ë” ì¶”ë¡  ì ìš©)

PDFëŠ” ìŠ¤íƒ€ì¼ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ íŒ¨í„´ ê¸°ë°˜ í—¤ë” ì¶”ë¡ :

| ì¶”ì¶œëœ í…ìŠ¤íŠ¸ | ë³€í™˜ í›„ |
|--------------|---------|
| `1 ëª©ì  Purpose` | `## 1 ëª©ì  Purpose` |
| `1.1 ë³¸ ê·œì •ì€...` | `### 1.1 ë³¸ ê·œì •ì€...` |
| `1.1.1 ì„¸ë¶€ í•­ëª©` | `#### 1.1.1 ì„¸ë¶€ í•­ëª©` |

**ë¬´ì‹œë˜ëŠ” íŒ¨í„´:** í˜ì´ì§€ ë²ˆí˜¸ (`1 of 11`), í—¤ë”/í‘¸í„°

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ë¬¸ì„œ ë²„ì „ ì°¨ì´

**ê°™ì€ ë¬¸ì„œë¼ë„ íŒŒì¼ í˜•ì‹ì— ë”°ë¼ ë‚´ìš©ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**

| íŒŒì¼ | ë‚´ìš© |
|------|------|
| `EQ-SOP-00009.docx` | ìˆ«ì ì—†ìŒ (`ì ˆì°¨ Procedure`) |
| `EQ-SOP-00009.pdf` | ìˆ«ì ìˆìŒ (`5 ì ˆì°¨ Procedure`) |

> âš¡ íŒŒì‹± ê²°ê³¼ëŠ” **ì›ë³¸ ë¬¸ì„œì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë°˜ì˜**í•©ë‹ˆë‹¤.

### íŒŒì¼ëª… í™•ì¥ì ê°ì§€

v9.0ì—ì„œëŠ” **ì‹¤ì œ í™•ì¥ì**ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼ íƒ€ì…ì„ ê²°ì •í•©ë‹ˆë‹¤:

```python
# âœ… ì˜¬ë°”ë¥¸ ê°ì§€
"report_docx.pdf" â†’ PDFë¡œ ì²˜ë¦¬
"data.backup.xlsx" â†’ XLSXë¡œ ì²˜ë¦¬
```

### PDF íŒŒì‹± ì œí•œ

- âŒ ìŠ¤ìº”ëœ ì´ë¯¸ì§€ PDF (OCR í•„ìš” - pytesseract ì„¤ì¹˜ ì‹œ ì§€ì›)
- âš ï¸ ë³µì¡í•œ ë ˆì´ì•„ì›ƒ (í…ìŠ¤íŠ¸ ìˆœì„œ ì„ì„ ê°€ëŠ¥)
- âš ï¸ í—¤ë” ì¶”ë¡  (íŒ¨í„´ ê¸°ë°˜, 100% ì •í™•í•˜ì§€ ì•ŠìŒ)

---

## ğŸ”„ ë²„ì „ íˆìŠ¤í† ë¦¬

| ë²„ì „ | ë‚ ì§œ | ì£¼ìš” ë³€ê²½ |
|------|------|----------|
| **v9.0** | 2025-01 | ğŸ”¥ LangGraph ìƒíƒœ ë¨¸ì‹  íŒŒì´í”„ë¼ì¸, ì¡°ê±´ë¶€ ë¶„ê¸°, í’ˆì§ˆ ê²€ì¦ |
| v8.1 | 2025-01 | ì»¨í…ìŠ¤íŠ¸ í”„ë¦¬í”½ìŠ¤, í…Œì´ë¸” ë³´ì¡´, ë©”íƒ€ë°ì´í„° í”„ë¡¬í”„íŠ¸ |
| v8.0 | 2025-01 | 4ë‹¨ê³„ ë§ˆí¬ë‹¤ìš´ íŒŒì´í”„ë¼ì¸ (ë³€í™˜â†’ë¶„í• â†’ìµœì í™”â†’ë©”íƒ€ë°ì´í„°) |
| v7.0 | 2025-01 | ì†Œì œëª© íŒ¨í„´ í™•ì¥, í™•ì¥ì ë²„ê·¸ ìˆ˜ì •, ë¬¸ì„œ í˜•ì‹ ìë™ ê°ì§€ |
| v6.3 | 2025-01 | section_path ê³„ì¸µ ì¶”ì , intro ë¸”ë¡ ì œì™¸ |

---

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### PDF ì—…ë¡œë“œ ì‹¤íŒ¨: "File is not a zip file"

**ì›ì¸:** íŒŒì¼ëª…ì— `docx`ê°€ í¬í•¨ë˜ì–´ DOCXë¡œ ì˜ëª» ì¸ì‹

**í•´ê²°:** v9.0ì—ì„œ ì‹¤ì œ í™•ì¥ì ê¸°ì¤€ ê°ì§€ë¡œ ìˆ˜ì •ë¨

### ì²­í¬ê°€ 0ê°œ

**ì›ì¸:** `exclude_intro=True`ë¡œ section_path ì—†ëŠ” ì²­í¬ ì œì™¸

**í•´ê²°:** í•„í„° ì—†ì´ ì¬ì‹œë„í•˜ê±°ë‚˜ `exclude_intro=False` ì„¤ì •

### LangGraph ë¯¸ì„¤ì¹˜

**í•´ê²°:**
```bash
pip install langgraph
```

ë¯¸ì„¤ì¹˜ ì‹œ ìë™ìœ¼ë¡œ v8.0 ì„ í˜• íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ í´ë°±

---

## ğŸ“„ ë¼ì´ì„ ìŠ¤

MIT License

---

## ğŸ¤ ê¸°ì—¬

ì´ìŠˆ ë° PR í™˜ì˜í•©ë‹ˆë‹¤!

```bash
git clone https://github.com/your-repo/rag-chatbot.git
cd rag-chatbot
pip install -r requirements.txt
python main.py
```